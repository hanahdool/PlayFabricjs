<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Title</title>
  <link rel="stylesheet" href="_cropping.css">
  <script src = "js/fabric.min.js"></script>
  <script src = "js/underscore.js"></script>
  <script src = "js/jquery.js"></script>
</head>
<body style="position:absolute">
<!--<canvas id="canvas" width="800" height="800" style="border: 1px solid black"></canvas>-->
<div id="filters">
  <ul class="clearfix">
    <li class="clearfix">
      <div class="block">	<a href="#" id="startCrop" class="button">Enter crop mode</a>

      </div>
      <div class="block">	<a href="#" id="crop" class="button">Crop</a>

      </div>
    </li>
  </ul>
</div>
<div id="canvas-container" class="over">
  <div class="canvas-container" style="width: 800px; height: 600px; position: relative; -webkit-user-select: none;">
    <canvas id="canvas" width="800" height="600"></canvas>
  </div>
</div>


<div id="my">
  <canvas id="myCanvas" width="600" height="600">

  </canvas>
  <button id="mySizingMode"> sizing mode </button>
  <button id="myCropMode"> crop mode </button>
  <button id="myCrop"> crop </button>

</div>

<script>

  // http://jsfiddle.net/86bTc/4/
  // 변형


/*

  var canvas = new fabric.Canvas('canvas');
  var el;
  var object, lastActive, object1, object2;
  var cntObj = 0;
  var selection_object_left = 0;
  var selection_object_top = 0;

  canvas.setBackgroundColor("yellow");

  var src = "http://fabricjs.com/lib/pug.jpg";
  fabric.Image.fromURL('http://serio.piiym.net/CVBla/txtboard/thumb/1260285874089s.jpg', function (oImg) {
    canvas.add(oImg);
  });

  fabric.Image.fromURL('image/black.png', function(img) {
    canvas.add(img);
  });

  fabric.Image.fromURL('image/dog.png', function(img) {
    canvas.add(img);
  });



  canvas.renderAll();

  var disabled;



  $('#startCrop').on('click', function () {

    canvas.remove(el);
    if (canvas.getActiveObject()) {

      object = canvas.getActiveObject();

//      if (lastActive !== object) {
//        console.log('different object');
//      } else {
//        console.log('same object');
//      }

//      if (lastActive && lastActive !== object) {
//        lastActive.clipTo = null; //results in clip loss - 없으면 크롭 후 따른거 크롭하려 하면 다시 돌아옴 // 원본 불러올 때 필요할까?
//      }

      el = new fabric.Rect({
        fill: 'rgba(0,0,0,0.3)',
        originX: 'left',
        originY: 'top',
        stroke: '#ccc', // selector할 때 내부 점선 ?
        strokeDashArray: [2, 2], // 이렇게 하면 점선
        opacity: 1,
        width: 1,
        height: 1,
        borderColor: '#36fd00', // selector 테두리
        cornerColor: 'green', // selector 작은사각형 9개 테두리
        hasRotatingPoint: false
      });


      // 원래 객체 크기, 위치에 맞춰서 setting
      el.left = canvas.getActiveObject().left;
      selection_object_left = canvas.getActiveObject().left;
      selection_object_top = canvas.getActiveObject().top;
      el.top = canvas.getActiveObject().top;
      el.width = canvas.getActiveObject().width * canvas.getActiveObject().scaleX;
      el.height = canvas.getActiveObject().height * canvas.getActiveObject().scaleY;


      canvas.add(el);
      canvas.setActiveObject(el);


      // 이게 뭐지?
      for (var i = 0; i < $("#layers li").size(); i++) {
        canvas.item(i).selectable = false;
      }
    } else {
      alert("Please select an object or layer");
    }

  });


  $('#crop').on('click', function (event) {

    var eLeft = el.get('left');
    var eTop = el.get('top');
    var left = eLeft - object.left;
    var top = eTop - object.top;

    left *= 1;
    top *= 1;

    var eWidth = el.get('width');
    var eHeight = el.get('height');
    var eScaleX = el.get('scaleX');
    var eScaleY = el.get('scaleY');
    var width = eWidth * 1;
    var height = eHeight * 1;
    object.clipTo = function (ctx) {
      ctx.rect(-(eWidth / 2) + left, -(eHeight / 2) + top, parseInt(width * eScaleX), parseInt(eScaleY * height));
    };

//    canvas.remove(object);

    for (var i = 0; i < $("#layers li").size(); i++) { // 이게 뭐지 도대체!!!?
      canvas.item(i).selectable = true;
    }
    disabled = true;

    canvas.remove(el);
    lastActive = object;
    canvas.renderAll();

  });


//  canvas.getActiveObject().selectable = false;


*/
/*


// do myself!

  var myCanvas = new fabric.Canvas('myCanvas');

  fabric.Image.fromURL('image/white.png', function (oImg) {
    myCanvas.add(oImg);
  });

  fabric.Image.fromURL('image/black.png', function(img) {
    myCanvas.add(img);
  });

  fabric.Image.fromURL('image/dog.png', function(img) {
    myCanvas.add(img);
    img.globalCompositeOperation = "source-atop";
  });



  $('#mySizingMode').on('click', function (e) {


  });

  $('#myCropMode').on('click', function (e) {


  });

  $('#myCrop').on('click', function (e) {


  });*/

  var canvas = new fabric.Canvas('canvas');
  var el;
  var object, lastActive, object1, object2;
  var cntObj = 0;
  var selection_object_left = 0;
  var selection_object_top = 0;

  var src = "http://fabricjs.com/lib/pug.jpg";
  fabric.Image.fromURL('http://serio.piiym.net/CVBla/txtboard/thumb/1260285874089s.jpg', function (oImg) {
//    oImg.setAngle();
    canvas.add(oImg);
  });

  fabric.Image.fromURL('http://www.clker.com/cliparts/2/5/6/5/1194986466653224692smiley110.svg.med.png', function (oImg1) {
    oImg1.top = 200;
    oImg1.left = 300;
    canvas.add(oImg1);

  });
  canvas.renderAll();


  // cropping
  $('#crop').on('click', function (event) {

    var eLeft = el.get('left');
    var eTop = el.get('top');
    var left = eLeft - object.left;
    var top = eTop - object.top;

    left *= 1;
    top *= 1;

    var eWidth = el.get('width');
    var eHeight = el.get('height');
    var eScaleX = el.get('scaleX');
    var eScaleY = el.get('scaleY');
    var width = eWidth * 1;
    var height = eHeight * 1;
    var ocs = _.pick(_.extend(canvas.getActiveObject().oCoords), 'tl', 'tr', 'br', 'bl');

    object.clipTo = function (ctx) {
      var center = object.getCenterPoint();

      var w = parseInt(width * eScaleX);
      var h = parseInt(eScaleY * height);
      var x = -(eWidth / 2) + left;
      var y = -(eHeight / 2) + top;

      ctx.rect(x, y, w, h);

      // 진짜로 잘라놓지 말고! 그부분 복제한 후, 원상태로 돌려두고,
      // 복제한 걸 그자리에 띄우고, 진짜는 캔버스에 안보이게 하기

//      ctx.beginPath();
//      ctx.moveTo(ocs.tl.x - center.x, ocs.tl.y - center.y);
//      ctx.lineTo(ocs.tr.x - center.x, ocs.tr.y - center.y);
//      ctx.lineTo(ocs.br.x - center.x, ocs.br.y - center.y);
//      ctx.lineTo(ocs.bl.x - center.x, ocs.bl.y - center.y);
//      ctx.lineTo(ocs.tl.x - center.x, ocs.tl.y - center.y);
//      ctx.closePath();
    };



    for (var i = 0; i < $("#layers li").size(); i++) {
      canvas.item(i).selectable = true;
    }
    disabled = true;

    // 삭제 전에 el 정보 넣기
    object.is_cropped = _.clone(el); // 얕은 복사로도 됨!!!

    canvas.remove(el);
    lastActive = object;

    canvas.renderAll();



  });


  // crop mode
  $('#startCrop').on('click', function () {
    console.log("enter crop mode!");
    canvas.remove(el); // 이전 내용 지우는 거!?
    if (canvas.getActiveObject()) {

      object = canvas.getActiveObject();

      if (lastActive && lastActive !== object) {
        lastActive.clipTo = null;
      }

      object.setWidth(object.width * object.scaleX);
      object.setHeight(object.height * object.scaleY);
      object.setScaleX(1);
      object.setScaleY(1);
      canvas.renderAll();

      el = new fabric.Rect({
        fill: 'rgba(0,0,0,0.3)',
        originX: 'left',
        originY: 'top',
        stroke: '#ccc',
        strokeDashArray: [2, 2],
        opacity: 1,
        width: 1,
        height: 1,
        borderColor: '#36fd00',
        cornerColor: 'green',
        hasRotatingPoint: false,
        angle: object.angle // activeObject 없으면 아예 이 함수를 들어오지 말았어야
      });

      el.left = object.left;
//      selection_object_left = object.left;
//      selection_object_top = object.top;
      el.top = object.top;
      el.width = object.width * object.scaleX;
      el.height = object.height * object.scaleY;


      if (object.is_cropped) {
        el = object.is_cropped; // rect(el) 크기 그대로 대입해줌
        // 이미지 그대로 다시 보여줌

      }

      canvas.add(el);
      canvas.setActiveObject(el);
      for (var i = 0; i < $("#layers li").size(); i++) {
        canvas.item(i).selectable = false;
      }

    } else {
      alert("Please select an object or layer");
    }

  });





  function clone_and_store() { // crop했을 때
    var active = canvas.getActiveObject();

    if (!active.original) {
      var cloned = fabric.util.object.clone(active);
    }

    canvas.setActiveObject(cloned);
    cloned.original = active;
    active.cloned = cloned;
    active.visible = false; // active.setVisible(false);
    canvas.add(cloned);


    active.clone(function(obj) {
      canvas.setActiveObject(obj);
      canvas.add(obj);
      active.visible = false; //active.remove();
    });

    canvas.renderAll();
  }

//  function load_origin_image() { // crop 모드 들어왔을 때
//    var active = canvas.getActiveObject();
//
//    console.log(active.original);
//    active.original.setVisible(true);
//    active.setVisible(false);
//
//    canvas.renderAll();
//  }




</script>


<script>


  //  var rect1 = new fabric.Rect({ width:150, height:150, top:200, left:200, fill:'rgba(100, 100, 200, 1)' });
  //  canvas.add(rect1);
  //
  //
  //  var text = new fabric.IText('라랄라랄텍스트~ 라라랄~', {
  //    fontSize: 50,
  //    left: 50,
  //    top: 0,
  //    lineHeight: 1,
  //    originX: 'left',
  //    fontFamily: 'Helvetica',
  //    fontWeight: 'bold',
  //    statefullCache: true
  //  });
  //  canvas.add(text);


</script>

</body>
</html>